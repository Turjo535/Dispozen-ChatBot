<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Places Map</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
      }

      #map {
        width: 100%;
        height: 500px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      #places-list {
        list-style: none;
      }

      #places-list li {
        padding: 15px;
        margin-bottom: 10px;
        background: #f9f9f9;
        border-left: 4px solid #dc3545;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }

      #places-list li:hover {
        background: #f0f0f0;
      }

      #places-list li strong {
        color: #333;
        font-size: 16px;
        display: block;
        margin-bottom: 5px;
      }

      #places-list li span {
        color: #666;
        font-size: 14px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .select-place-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        transition: background 0.3s;
      }

      .select-place-btn:hover {
        background: #c82333;
      }

      .select-place-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="page-title">Loading...</h1>
      <div id="error-message"></div>
      <div id="success-message"></div>
      <div id="map"></div>
      <h2 id="list-title">Places</h2>
      <ul id="places-list">
        <li class="loading">Loading places...</li>
      </ul>
    </div>

    <script>
      // Get organizer_id from Django template
      const organizerId = {{ organizer_id|default:"null" }};
      console.log('Organizer ID:', organizerId);

      let map, infoWindow;
      let places = [];
      let markers = [];

      // Extract query parameters from URL
      const urlParams = new URLSearchParams(window.location.search);
      const searchLocation = urlParams.get('location') || 'Khulna';
      const searchCategory = urlParams.get('catagory') || 'Hospital';
      const searchSubCategory = urlParams.get('sub-catagory') || 'private';

      // Initialize Google Map
      window.initMap = function() {
          console.log('initMap called');

          map = new google.maps.Map(document.getElementById('map'), {
              center: { lat: 22.8409, lng: 89.5387 },
              zoom: 13,
          });

          infoWindow = new google.maps.InfoWindow();

          if (places.length) {
              addMarkers();
              centerMapOnPlaces();
          }
      };

      // Update page title
      document.getElementById('page-title').textContent = `${searchCategory} Locations in ${searchLocation}`;
      document.getElementById('list-title').textContent = `Found ${searchCategory}s`;

      console.log('Query Parameters:', {
          location: searchLocation,
          category: searchCategory,
          subCategory: searchSubCategory
      });

      // Fetch places from API
      fetch(`/api/maps/?location=${encodeURIComponent(searchLocation)}&catagory=${encodeURIComponent(searchCategory)}&sub-catagory=${encodeURIComponent(searchSubCategory)}`)
          .then(response => {
              console.log('Response status:', response.status);

              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              return response.json();
          })
          .then(data => {
              console.log('API Data:', data);

              if (data.error) {
                  throw new Error(data.error);
              }

              places = data.places || [];

              if (places.length === 0) {
                  showError('No places found for the given criteria.');
                  return;
              }

              document.getElementById('list-title').textContent = `Found ${places.length} ${searchCategory}(s)`;

              if (map) {
                  addMarkers();
                  centerMapOnPlaces();
              }

              displayPlacesList();
          })
          .catch(error => {
              console.error('Fetch error:', error);
              showError(`Failed to load places: ${error.message}`);
          });

      // Show error message
      function showError(message) {
          const errorDiv = document.getElementById('error-message');
          errorDiv.className = 'error';
          errorDiv.textContent = message;

          const placesList = document.getElementById('places-list');
          placesList.innerHTML = '<li class="error">Failed to load places</li>';
      }

      // Show success message
      function showSuccess(message) {
          const successDiv = document.getElementById('success-message');
          successDiv.className = 'success';
          successDiv.textContent = message;

          setTimeout(() => {
              successDiv.textContent = '';
              successDiv.className = '';
          }, 3000);
      }

      // Add markers to map
      function addMarkers() {
          markers = [];

          places.forEach((place, index) => {
              const marker = new google.maps.Marker({
                  position: { lat: place.latitude, lng: place.longitude },
                  map: map,
                  title: place.name,
                  icon: {
                      url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                  }
              });

              markers.push(marker);

              marker.addListener('click', () => {
                  const content = `
                      <div style="padding: 10px; min-width: 250px;">
                          <h3 style="margin: 0 0 10px 0; color: #333;">${escapeHtml(place.name)}</h3>
                          <p style="margin: 0 0 5px 0; color: #666;">${escapeHtml(place.address)}</p>
                          <p style="margin: 0 0 10px 0; font-size: 12px; color: #999;">
                              Lat: ${place.latitude}, Lng: ${place.longitude}
                          </p>
                          <button
                              class="select-place-btn"
                              onclick="selectPlace(${index})"
                              id="select-btn-${index}">
                              Select this place
                          </button>
                      </div>
                  `;

                  infoWindow.setContent(content);
                  infoWindow.open(map, marker);
              });
          });
      }

      // Handle place selection and redirect to Messenger
      window.selectPlace = function(index) {
          const place = places[index];
          const button = document.getElementById(`select-btn-${index}`);
          
          console.log('Selected place:', place);

          if (!place) {
              alert('Place not found');
              return;
          }

          if (!organizerId) {
              alert('Organizer ID is missing');
              return;
          }

          button.disabled = true;
          button.textContent = 'Saving...';

          const placeData = {
              name: place.name,
              address: place.address,
              latitude: place.latitude,
              longitude: place.longitude,
              category: searchCategory,
              sub_category: searchSubCategory,
              location: searchLocation,
              organizer_id: organizerId
          };

          console.log('Saving place:', placeData);

          fetch('/api/select-place/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(placeData)
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}`);
              }
              return response.json();
          })
          .then(data => {
              console.log('Save response:', data);

              if (!data.success) {
                  throw new Error(data.error || 'Failed to save place');
              }

              showSuccess(`✓ ${place.name} has been saved successfully! Redirecting to Messenger...`);

              button.textContent = 'Selected ✓';
              button.style.background = '#28a745';

              // Redirect to Messenger after 1.5 seconds
              setTimeout(() => {
                  console.log('Redirecting to Messenger now...');
                  window.location.href = 'https://m.me/dispozen.bot?ref=w43967400';
              }, 1500);
          })
          .catch(error => {
              console.error('Save error:', error);
              alert(`Failed to save place: ${error.message}`);

              button.disabled = false;
              button.textContent = 'Select this place';
          });
      };

      // Center map on places
      function centerMapOnPlaces() {
          if (places.length === 0) return;

          const bounds = new google.maps.LatLngBounds();
          places.forEach(place => {
              bounds.extend({ lat: place.latitude, lng: place.longitude });
          });

          map.fitBounds(bounds);

          if (places.length === 1) {
              map.setZoom(15);
          }
      }

      // Display places list
      function displayPlacesList() {
          const ul = document.getElementById('places-list');
          ul.innerHTML = '';

          places.forEach((place, index) => {
              const li = document.createElement('li');
              li.innerHTML = `
                  <strong>${index + 1}. ${escapeHtml(place.name)}</strong>
                  <span>${escapeHtml(place.address)}</span>
              `;

              li.addEventListener('click', () => {
                  map.setCenter({ lat: place.latitude, lng: place.longitude });
                  map.setZoom(16);

                  if (markers[index]) {
                      google.maps.event.trigger(markers[index], 'click');
                  }
              });

              ul.appendChild(li);
          });
      }

      // Escape HTML to prevent XSS
      function escapeHtml(str) {
          if (!str) return '';
          return String(str)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
      }
    </script>

    <!-- Load Google Maps script -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=initMap&libraries=places"
      async
      defer
    ></script>
  </body>
</html>